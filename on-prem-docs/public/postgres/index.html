<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
<meta http-equiv="x-ua-compatible" content="ie=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Postgres Migration</title>
<link rel="shortcut icon" type="image/png" href="/images/favicon.ico" />
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/docsearch.js@2/dist/cdn/docsearch.min.css" />

  <link rel="stylesheet" href="/css/chef-sh.css" />
</head>

<body>
  <div class="off-canvas-wrapper has-sidebar">
    <div class="off-canvas-content" data-off-canvas-content>
      <div class="cell small-12">
        <nav id="utility-bar" class="utility-bar" data-toggler="active">
  <div class="grid-container">
    <div class="grid-x align-right">
      <div class="cell medium-7 utility-bar-wrapper text-right">
        <button type="button" class="utility-bar-button" data-toggle="utility-bar">
          <span class="show-for-medium">Explore the <span class="chef-logo"><span class="sr-only">Chef</span></span> Automation Portfolio</span>
          <span class="show-for-small-only">Chef Automation</span>
          <span class="arrow"><span class="sr-only">Expand</span></span>
        </button>
        <div class="utility-bar-content text-left">
          <div class="grid-x">
            <div class="oss-projects grid-x" data-equalizer>
              <div class="cell medium-4">
                <a href="https://chef.sh">
                  <div data-equalizer-watch><img src="/images/chef-logo.svg" alt="Chef" width="131" class="chef"></div>
                  <p>Ensure configurations are applied consistently in every environment, at any scale.</p>
                </a>
              </div>
              <div class="cell medium-4">
                <a href="https://inspec.io">
                  <div data-equalizer-watch><img src="/images/inspec-logo.svg" alt="Inspec" width="133" class="inspec"></div>
                  <p>Automate the validation of compliance and security in any environment, on any platform.</p>
                </a>
              </div>
              <div class="cell medium-4">
                <a href="https://habitat.sh">
                  <div data-equalizer-watch><img src="/images/habitat-logo.svg" alt="Habitat" width="111" class="habitat"></div>
                  <p>Automate the process of building, deploying, and managing any application in any environment.</p>
                </a>
              </div>
            </div>
            <div class="automate cell small-12">
              <div class="cell small-12">
                <a href="https://automate.chef.io" class="with-arrow-button">
                  <img src="/images/chef-automate-logo.svg" alt="Chef Automate" width="217" class="chef-automate">
                  <p>Build, deploy, and manage faster, more efficiently, and with less risk with Chef Automate, the continuous automation platform.</p>
                </a>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</nav>

      </div>
      <div id="menu" class="cell small-12" data-sticky-container>
        

<nav data-sticky class="sticky" style="min-width:100%;" data-check-every="0" data-sticky-on="small" data-margin-top="0" data-top-anchor="utility-bar:bottom">
  <header>
    <div class="grid-container">
      <div class="grid-x">
        <div id="header-logo" class="cell large-3 small-11">
          <a href="/"><img src="/images/chef-logo.svg" alt="Chef Habitat Builder on-prem documentation"></a>
        </div>
        <div id="header-toggle" data-responsive-toggle="header-menu" data-hide-for="large" class="cell small-1">
          <div class="valign-small">
            <button type="button" data-toggle="header-menu" aria-label="Menu"><i aria-hidden="true" class="fas fa-bars fa-lg"></i></button>
          </div>
        </div>
        <div id="header-menu" class="cell large-9 small-12">
          <ul class="vertical medium-horizontal menu">
            
          </ul>
        </div>

      </div>
    </div>
  </header>
</nav>

      </div>
      <div id="main-content" class="cell small-12" data-sticky-container>
        <div class="grid-container">
          <div class="grid-x">
            <div class="cell medium-3 col-sidebar">
              


<aside class="sticky" data-sticky data-anchor="main-content-col" data-margin-top="4" data-margin-bottom="2">
  <nav id="sidebar-nav">
    
    
    <div class="nav">
      <ul class="vertical menu accordion-menu" data-accordion-menu>
        
      </ul>
    </div>
  </nav>
</aside>

            </div>
            <div id="main-content-col" class="cell medium-9 col-content">
              
<h1>Postgres Migration</h1>
<div class="prose">
  

<h1 id="postgres-migration">Postgres Migration</h1>

<h2 id="merging-database-shards">Merging Database Shards</h2>

<p>This section is for installations of On-Premise Depot that were done <em>prior</em> to
August 17th 2018. If you re-install or upgrade to a newer version of the
On-Premise Depot, you will be required to also merge your database shards into
the <code>public</code> Postgres database schema. Please follow the steps below.</p>

<h3 id="shard-migration-pre-requisites">Shard Migration Pre-requisites</h3>

<ol>
<li>The password to your Postgres database. By default, this is located at
<code>/hab/svc/builder-datastore/config/pwfile</code></li>

<li><p>A fresh backup of the two databases present in the On-Premise Depot,
<code>builder_sessionsrv</code> and <code>builder_originsrv</code>. You can create such a backup
with <code>pg_dump</code>:</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="color:#b8860b">PGPASSWORD</span><span style="color:#666">=</span><span style="color:#a2f;font-weight:bold">$(</span>sudo cat /hab/svc/builder-datastore/config/pwfile<span style="color:#a2f;font-weight:bold">)</span> hab pkg <span style="color:#a2f">exec</span> core/postgresql pg_dump -h <span style="color:#666">127</span>.0.0.1 -p <span style="color:#666">5432</span> -U hab builder_originsrv &gt; builder-originsrv.sql</code></pre></div></li>
</ol>

<h3 id="shard-migration">Shard Migration</h3>

<ol>
<li>Uninstall existing services by running <code>sudo -E ./uninstall.sh</code></li>
<li>Install new services by running <code>./install.sh</code></li>
<li>If you check your logs at this point, you will likely see lines like this:
<code>Shard migration hasn't been completed successfully</code> repeated over and over
again, as the supervisor tries to start the new service, but the service
dies because the migration hasn&rsquo;t been run.</li>

<li><p>Optionally, if you want to be extra sure that you&rsquo;re in a good spot to perform the
migration, log into the Postgres console and verify that you have empty
tables in the <code>public</code> schema. A command to do this might look like:</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="color:#b8860b">PGPASSWORD</span><span style="color:#666">=</span><span style="color:#a2f;font-weight:bold">$(</span>sudo cat /hab/svc/builder-datastore/config/pwfile<span style="color:#a2f;font-weight:bold">)</span> hab pkg <span style="color:#a2f">exec</span> core/postgresql psql -h <span style="color:#666">127</span>.0.0.1 -p <span style="color:#666">5432</span> -U hab builder_originsrv</code></pre></div></li>
</ol>

<p>That should drop you into a prompt where you can type <code>\d</code> and hopefully see
   a list of tables where the schema says <code>public</code>. If you try to select data
   from any of those tables, they should be empty. Note that this step is
   definitely not required, but can be done if it provides you extra peace of
   mind.
1. Now you are ready to migrate the data itself. The following command will do
   that for <code>builder-originsrv</code>:</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">   <span style="color:#b8860b">PGPASSWORD</span><span style="color:#666">=</span><span style="color:#a2f;font-weight:bold">$(</span>sudo cat /hab/svc/builder-datastore/config/pwfile<span style="color:#a2f;font-weight:bold">)</span> ./scripts/merge-shards.sh originsrv migrate</code></pre></div>
<p>After confirming that you have fresh database backups, the script
   should run and at the end, you should see several notices that everything is
   great, row counts check out, and your database has been marked as migrated.
1. Do the same migration for <code>builder-sessionsrv</code>.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">   <span style="color:#b8860b">PGPASSWORD</span><span style="color:#666">=</span><span style="color:#a2f;font-weight:bold">$(</span>sudo cat /hab/svc/builder-datastore/config/pwfile<span style="color:#a2f;font-weight:bold">)</span> ./scripts/merge-shards.sh sessionsrv migrate</code></pre></div>
<ol>
<li>Double check the logs for <code>builder-originsrv</code> and <code>builder-sessionsrv</code> to
make sure things look normal again. If there are still errors, restart the
services.</li>
<li>At this point, all data is stored in the <code>public</code> schema. All of the other
schemas, from <code>shard_0</code> up to <code>shard_127</code> will still be present in your
database, and the data in them will remain intact, but the services will no
longer reference those shards.</li>
</ol>

<h2 id="merging-databases">Merging Databases</h2>

<p>This section is for installations of On-Premise Depot that were done <em>after</em>
the database shard migration listed above. If upgrade to a newer version of the
On-Premise Depot, you will be required to also merge databases into
the <code>builder</code> Postgres database. Please follow the steps below.</p>

<h3 id="database-merge-pre-requisites">Database Merge Pre-requisites</h3>

<ol>
<li>The password to your Postgres database. By default, this is located at
<code>/hab/svc/builder-datastore/config/pwfile</code></li>

<li><p>A fresh backup of the two databases present in the On-Premise Depot,
<code>builder_sessionsrv</code> and <code>builder_originsrv</code>. You can create such a backup
with <code>pg_dump</code>:</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="color:#b8860b">PGPASSWORD</span><span style="color:#666">=</span><span style="color:#a2f;font-weight:bold">$(</span>sudo cat /hab/svc/builder-datastore/config/pwfile<span style="color:#a2f;font-weight:bold">)</span> hab pkg <span style="color:#a2f">exec</span> core/postgresql pg_dump -h <span style="color:#666">127</span>.0.0.1 -p <span style="color:#666">5432</span> -U hab builder_originsrv &gt; builder-originsrv.sql</code></pre></div></li>
</ol>

<h3 id="database-merge-migration">Database Merge Migration</h3>

<ol>
<li><p>With all services running your <em>current</em> versions, execute the following command from the root of the repo directory:</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="color:#b8860b">PGPASSWORD</span><span style="color:#666">=</span><span style="color:#a2f;font-weight:bold">$(</span>sudo cat /hab/svc/builder-datastore/config/pwfile<span style="color:#a2f;font-weight:bold">)</span> ./scripts/merge-databases.sh</code></pre></div></li>
</ol>

<p>After confirming that you have fresh database backups, the script
   should run and create a new &lsquo;builder&rsquo; database, and then migrate the data.
1. At this point, all data is stored in the <code>builder</code> database. Both of the other
   databases (<code>builder_originsrv</code> and <code>builder_sessionsrv</code>) will still be present,
   and the data in them will remain intact, but new services will no
   longer reference those databases.
1. Now, stop and uninstall the existing services by running <code>sudo -E ./uninstall.sh</code>
1. Install new services by running <code>./install.sh</code>
1. Once the new services come up, you should be able to log back into the depot UI and confirm that everything is as expected.</p>

</div>

            </div>
          </div>
        </div>
      </div>
      <div id="footer" class="cell small-12">
        <div class="grid-x">
          <div class="cell small-12">
            <nav>
              
<footer>
  <div class="grid-container">
    <div class="grid-x align-middle">
      <div class="cell small-12 large-3 logo"><a href="/"><img src="/images/chef-logo-light.svg" alt="Chef Habitat Builder on-prem documentation"></a></div>
      <div class="cell small-12 large-9">
        <ul class="menu vertical medium-horizontal">
          <li><a href="https://www.chef.io/online-master-agreement/" target="_blank">Licensing</a></li>
          <li><a href="https://www.chef.io/terms-of-service/" target="_blank">Terms &amp; Conditions</a></li>
          <li><a href="https://www.chef.io/trademark-policy/" target="_blank">Trademark Policy</a></li>
          <li><a href="https://www.chef.io/privacy-policy/" target="_blank">Privacy Policy</a></li>
          <li><a href="https://www.chef.io/cookie-policy/" target="_blank">Cookie Policy</a></li>
        </ul>
        <p class="legal">&copy; 2008-2019 Chef Software, Inc. All Rights Reserved.</p>
      </div>
    </div>
  </div>
</footer>

            </nav>
          </div>
        </div>
      </div>
    </div>
  </div>
  <script src="/js/scripts-all.js"></script>
  <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/docsearch.js@2/dist/cdn/docsearch.min.js"></script>
  <script type="text/javascript">
    docsearch({
      apiKey: '3f16191e15b2b4a4b0823c9f856e2de2',
      indexName: 'chef_sh',
      inputSelector: '#doc-search',
      debug: false 
    });
  </script>
</body>
</html>
